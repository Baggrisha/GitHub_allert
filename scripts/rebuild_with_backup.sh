#!/usr/bin/env bash
set -euo pipefail

CONTAINER_NAME=githubbot
DB_PATH=/app/data/bot.db
BACKUP_DIR=./backups

echo "=== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ==="

git pull

echo "=== –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ ==="

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
CURRENT_BACKUP="${BACKUP_DIR}/bot_${TIMESTAMP}.db"
mkdir -p "${BACKUP_DIR}"

echo "üì• –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    if docker exec ${CONTAINER_NAME} test -f ${DB_PATH}; then
        docker cp ${CONTAINER_NAME}:${DB_PATH} "${CURRENT_BACKUP}"
        echo "‚úÖ –ë—ç–∫–∞–ø –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–∑–¥–∞–Ω: ${CURRENT_BACKUP}"
    else
        echo "‚ö†Ô∏è  –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –±—ç–∫–∞–ø..."
        CURRENT_BACKUP=$(ls -1t ${BACKUP_DIR}/bot_*.db 2>/dev/null | head -n 1 || true)
        if [ -z "${CURRENT_BACKUP}" ]; then
            echo "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è!"
            exit 1
        fi
        echo "üì¶ –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø: ${CURRENT_BACKUP}"
    fi
else
    echo "‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –±—ç–∫–∞–ø..."
    CURRENT_BACKUP=$(ls -1t ${BACKUP_DIR}/bot_*.db 2>/dev/null | head -n 1 || true)
    if [ -z "${CURRENT_BACKUP}" ]; then
        echo "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è!"
        exit 1
    fi
    echo "üì¶ –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø: ${CURRENT_BACKUP}"
fi

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
echo "–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞..."
docker compose build --pull --no-cache=false

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose down

# –ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "–ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose up -d

# –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
echo "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
for i in {1..30}; do
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ${CONTAINER_NAME} –∑–∞–ø—É—â–µ–Ω"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∑–∞ 30 —Å–µ–∫—É–Ω–¥"
        exit 1
    fi
    sleep 1
done

# –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫
echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞: ${CURRENT_BACKUP}"
docker cp "${CURRENT_BACKUP}" ${CONTAINER_NAME}:${DB_PATH}

echo "üéâ –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤—Å–µ—Ö –±–¥"
